version: '3.8'
services:
  n8n:
    image: n8nio/n8n:{{ n8n_image_tag }}
    user: "1000:1000"
    restart: unless-stopped
    ports:
      - "{{ n8n_port | default('5678') }}:5678"
    environment:
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: "{{ n8n_basic_auth_user }}"
      N8N_BASIC_AUTH_PASSWORD: "{{ n8n_basic_auth_password }}"
      N8N_HOST: "{{ n8n_domain }}"
      N8N_PORT: "{{ n8n_port | default('5678') }}"
      N8N_PROTOCOL: "https"
      GENERIC_TIMEZONE: "Europe/Prague"
      WEBHOOK_URL: "{{ n8n_webhook_url }}"
      DB_TYPE: "{{ n8n_database_type }}"
      DB_POSTGRESDB_HOST: "{{ n8n_database_host }}"
      DB_POSTGRESDB_PORT: "{{ n8n_database_port }}"
      DB_POSTGRESDB_DATABASE: "{{ n8n_database_name }}"
      DB_POSTGRESDB_USER: "{{ n8n_database_user }}"
      DB_POSTGRESDB_PASSWORD: "{{ n8n_database_password }}"
      N8N_USER_MANAGEMENT_DISABLED: "false"
    volumes:
      - n8n_data:/home/node/.n8n
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

volumes:
  n8n_data: